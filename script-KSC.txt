#Search number in log hotspot  :local smtpserv [:resolve "mail.ksc.ru"];  :local Eaccount "router@ksc.ru";  :local passwd "***REMOVED***"; :foreach line in=[/log find buffer=hotspot message~"login failed: no more sessions are allowed"] do={	:do {:local content [/log get $line message];	:put $content;    :local pos1 [:find $content " (" 0];  :put $pos1;  :if ($pos1 != " ") do={    :local uname "";    :local uname7 "";   :local uname8 "";   :local uname9 "";   :local phone "";    :local mess "";   :local mess1 "Достигнут+лимит+подключений+на+логин+";   :local mess2 ".+Если+сессии+заняты+не+вашими+устройствами,+то+запросите+код+заново+и+авторизуйтесь+повторно.+Если+данное+сообщение+приходит+и+после+этого,+подождите+30+минут+перед+повторной+попыткой+подключения.+С+уважением,+ФИЦ+КНЦ+РАН";    :set uname [:pick $content ($pos1-12) ($pos1-0)];    :put $uname;	:set mess ($mess1 . $uname . $mess2);	:put $mess;	##SMS	do {/tool fetch mode=http url="http://sms.ksc.loc/api.php"  http-method=post  http-data="phone=$uname&message=$mess" keep-result=no} on-error={};	#Email    do {/tool e-mail send from=router@ksc.ru to=root@ksc.ru server=$smtpserv port=25 user=$Eaccount password=$passwd subject="У пользователя $uname лимит сессий исчерпан" body="У пользователя Wi-Fi $uname исчерпан лимит сессий."} on-error={};  }  # Clear hostpot log/system logging action set hotspot memory-lines=1;/system logging action set hotspot memory-lines=1000;  }  }:foreach line in=[/log find buffer=hotspot message~"login failed: password"] do={ :do {:local content [/log get $line message];  :put $content;    :local pos1 [:find $content " (" 0];  :put $pos1;  :if ($pos1 != " ") do={    :local uname "";    :local uname7 "";   :local uname8 "";   :local uname9 "";   :local phone "";    :local mess "";   :local mess1 "Ваш+пароль+от+WiFi:+";   :local mess2 "+.Он+станет+недействительным,+если+не+подключаться+к+сети+более+3+дней.+Максимальное+количество+устройств+на+логин+2.+С+уважением,+ФИЦ+КНЦ+РАН";    :set uname [:pick $content ($pos1-12) ($pos1-0)];      :put $uname;    #Password generation     :local date [/system clock get time];     :local hour [:pick $date 0 2];     :local min [:pick $date 3 5];     :local sec [:pick $date 6 8];     :local usernumber [:pick $content ($pos1-7) ($pos1-5)];	    :put $usernumber;    :global pass 27394;     :set pass ($hour * $min * $sec - $usernumber);    :if ($pass = 0) do={      :set pass 6524;     }    :put $pass;    :set mess ($mess1 . $pass . $mess2);#     :set mess ("Your+password+is+" . $pass); #    :set mess $pass;    :put $mess;#    :log info "$mess";    #Add user to hotspot / user-manager     do {/ip hotspot user add name=$uname} on-error={};    do {/ip hotspot user set password=$pass numbers=[find name=$uname]} on-error={};    #do {/tool user-manager user add username=$uname password=$pass customer=admin copy-from=test disabled=no phone=$uname;} on-error={};    #do {/tool user-manager user set password=$pass number=[find username=$uname]} on-error={};     ##SMS.ru    #do {/tool fetch url="http://sms.ksc.loc/index.php\?phone=$uname&message=$mess" keep-result=no} on-error={};    do {/tool fetch mode=http url="http://sms.ksc.loc/api.php"  http-method=post  http-data="phone=$uname&message=$mess" keep-result=no} on-error={};    #do {/tool sms send usb1 phone-number="$uname7" message="login $uname password $pass"} on-error={};    #Email    do {/tool e-mail send from=router@ksc.ru to=root@ksc.ru server=$smtpserv port=25 user=$Eaccount password=$passwd subject="Новый пользователь Wi-Fi с номером телефона $uname" body="Авторизован новый пользователь Wi-Fi.\r\nЛогин: $uname\r\nПароль: $pass"} on-error={};      }# Clear hostpot log/system logging action set hotspot memory-lines=1;/system logging action set hotspot memory-lines=1000; }}